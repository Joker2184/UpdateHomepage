name: Sync to AList via WebDAV

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  sync_to_alist:
    runs-on: ubuntu-latest
    env:
      WEBDAV_URL: http://${{ secrets.WEBDAV_HOST }}:${{ secrets.WEBDAV_PORT }}/dav
      WEBDAV_USER: ${{ secrets.ALIST_USERNAME }}
      WEBDAV_PASS: ${{ secrets.ALIST_PASSWORD }}

    steps:
      # 1. Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Install rclone
      - name: Install rclone
        run: |
          curl https://rclone.org/install.sh | sudo bash

      # 3. Configure rclone using a temporary config file (secure & reliable)
      - name: Configure rclone for WebDAV
        run: |
          mkdir -p "$HOME/.config/rclone"
          cat > "$HOME/.config/rclone/rclone.conf" <<EOF
[alist_webdav]
type = webdav
url = ${WEBDAV_URL}
user = ${WEBDAV_USER}
pass = ${WEBDAV_PASS}
vendor = other
EOF
        shell: bash

      # 4. Debug: List local files
      - name: List local files
        run: |
          pwd
          ls -R

      # 5. Test WebDAV connection
      - name: Test WebDAV connection
        run: |
          echo "Testing WebDAV connection..."
          rclone lsd alist_webdav: || { echo "Connection failed!"; exit 1; }
          echo "WebDAV connection successful."

      # 6. Clear target folder on AList WebDAV (optional)
      - name: Clear target folder on AList WebDAV
        run: |
          echo "Deleting existing files in WebDAV root..."
          rclone delete --verbose --retries 3 alist_webdav:/ || true
          rclone rmdirs --verbose --retries 3 alist_webdav:/ || true  # safer than rmdir

      # 7. Sync all files to AList WebDAV
      - name: Sync all files to AList
        run: |
          echo "Starting sync to WebDAV..."
          rclone copy . alist_webdav:/ \
            --checksum \
            --verbose \
            --retries 3 \
            --transfers 4 \
            --exclude=".git/**" \
            --exclude="README.md"  # Optional: exclude files if needed

      # 8. Clean up rclone config for security
      - name: Clean up rclone config
        if: always()
        run: |
          echo "Cleaning up rclone config..."
          rm -rf "$HOME/.config/rclone"
