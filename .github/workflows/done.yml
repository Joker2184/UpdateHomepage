name: Sync to Alist via WebDAV

on:
  schedule:
    - cron: "0 1 * * *"  # æ¯å¤© UTC 1 ç‚¹è¿è¡Œ
  workflow_dispatch:

jobs:
  sync_to_alist:
    runs-on: ubuntu-latest
    steps:
      # 1. ç­¾å‡ºä»“åº“
      - name: ğŸ” Checkout repository
        uses: actions/checkout@v4

      # 2. å®‰è£… rclone
      - name: ğŸš€ Install rclone
        run: |
          echo "Installing rclone..."
          curl -s https://rclone.org/install.sh | sudo bash
          rclone version

      # 3. è°ƒè¯•ï¼šæ‰“å°è„±æ•çš„é…ç½®ä¿¡æ¯ï¼ˆGitHub ä¼šè‡ªåŠ¨ mask secretsï¼‰
      - name: ğŸ” Debug: Show WebDAV config (secrets masked by GitHub)
        run: |
          echo "WEBDAV_HOST: ${{ secrets.WEBDAV_HOST }}"
          echo "WEBDAV_PORT: ${{ secrets.WEBDAV_PORT }}"
          echo "ALIST_USERNAME: ${{ secrets.ALIST_USERNAME }}"
          echo "WebDAV URL: https://${{ secrets.WEBDAV_HOST }}:${{ secrets.WEBDAV_PORT }}/dav"

      # 4. é…ç½® rclone
      - name: âš™ï¸ Configure rclone for AList WebDAV
        run: |
          echo "Creating rclone config for alist_webdav..."
          rclone config create alist_webdav webdav \
            url "https://${{ secrets.WEBDAV_HOST }}:${{ secrets.WEBDAV_PORT }}/dav" \
            vendor "other" \
            user "${{ secrets.ALIST_USERNAME }}" \
            pass "${{ secrets.ALIST_PASSWORD }}"
          echo "Config created."

      # 5. æµ‹è¯•è¿æ¥ï¼šåˆ—å‡ºè¿œç¨‹ç›®å½•
      - name: ğŸ“‹ Test: List remote WebDAV directory
        run: |
          echo "Testing connection to AList WebDAV..."
          rclone lsd alist_webdav: --verbose

      # 6. åŒæ­¥æ–‡ä»¶
      - name: ğŸ“¤ Sync files to AList WebDAV
        run: |
          echo "Starting sync from ./ to alist_webdav:/ ..."
          rclone sync ./ alist_webdav:/ \
            --checksum \
            --ignore-times \
            --retries 3 \
            --verbose \
            --progress

      # 7. æ¸…ç†
      - name: ğŸ§¹ Clean up rclone config
        if: always()
        run: |
          echo "Cleaning up rclone config..."
          rm -rf ï½/.config/rclone
