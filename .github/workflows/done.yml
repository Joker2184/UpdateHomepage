name: Sync to Alist via WebDAV

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  sync_to_alist:
    runs-on: ubuntu-latest
    steps:
      # ç­¾å‡ºä»“åº“
      - name: Checkout repository
        uses: actions/checkout@v3

      # å®‰è£… rclone
      - name: ğŸš€ Install rclone
        run: |
          curl https://rclone.org/install.sh | sudo bash

      # é…ç½® rclone for WebDAV (Alist) with test credentials
      - name: âš™ï¸ Configure rclone for WebDAV (Alist)
        run: |
          rclone config create alist_webdav webdav \
            url https://pclhomeplazaoss.lingyunawa.top:26993 \
            vendor other \
            user Joker2184 \
            pass Joker2184@Alist

      # æµ‹è¯•è¿æ¥
      - name: ğŸ” Test WebDAV connection
        run: |
          echo "Testing connection to WebDAV server..."
          rclone ls alist_webdav:/ --max-depth 1

      # æ£€æŸ¥å½“å‰å·¥ä½œç›®å½•
      - name: ğŸ“‚ Print current working directory
        run: |
          pwd
          ls -al

      # åˆ—å‡ºåˆ é™¤å‰çš„æ–‡ä»¶
      - name: ğŸ“‹ List files before deletion
        run: |
          echo "Files before deletion:"
          rclone ls alist_webdav:/ --max-depth 3 || echo "No files found or access denied"

      # åˆ é™¤ç›®æ ‡ç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶
      - name: ğŸ—‘ï¸ Delete all files in target directory
        run: |
          echo "Deleting all files in WebDAV directory..."
          # é¦–å…ˆåˆ—å‡ºæ‰€æœ‰é¡¹ç›®
          ITEMS=$(rclone lsf alist_webdav:/ --recursive | sort -r)
          
          # åˆ é™¤æ¯ä¸ªé¡¹ç›®
          for item in $ITEMS; do
            echo "Deleting $item"
            rclone deletefile "alist_webdav:/$item" --retries 3 || echo "Failed to delete $item, continuing..."
          done
          
          # å°è¯•åˆ é™¤ç©ºç›®å½•
          rclone rmdir alist_webdav:/ --retries 3 || echo "Root directory may not be removable"

      # ç­‰å¾…ç‰‡åˆ»ä»¥ç¡®ä¿åˆ é™¤å®Œæˆ
      - name: â³ Wait for deletion processing
        run: sleep 5

      # éªŒè¯åˆ é™¤ç»“æœ
      - name: âœ… Verify deletion
        run: |
          echo "Verifying deletion:"
          rclone ls alist_webdav:/ --max-depth 1 || echo "Directory is now empty"

      # å¤åˆ¶ä»“åº“æ‰€æœ‰æ–‡ä»¶åˆ°WebDAV
      - name: ğŸ“¤ Copy all repository files to Alist WebDAV
        run: |
          echo "Copying all repository files to WebDAV..."
          # å¤åˆ¶æ‰€æœ‰ééšè—æ–‡ä»¶å’Œç›®å½•ï¼ˆæ’é™¤ .gitï¼‰
          rclone copy ./ alist_webdav:/ --checksum --size-only --retries 3 --verbose --exclude ".git/**" --exclude ".github/**"

      # éªŒè¯åŒæ­¥ç»“æœ
      - name: ğŸ§ª Verify sync result
        run: |
          echo "Files after sync:"
          rclone ls alist_webdav:/ --recursive | head -20
          echo "Total size:"
          rclone size alist_webdav:/

      # æ¸…ç† rclone é…ç½®
      - name: ğŸ§¹ Clean up rclone config
        if: always()
        run: rm -rf ~/.config/rclone
