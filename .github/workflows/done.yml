name: Sync to Alist via WebDAV

on:
  schedule:
    - cron: "0 1 * * *"
  workflow_dispatch:

jobs:
  sync_to_alist:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ” Checkout repository
        uses: actions/checkout@v4

      - name: ðŸš€ Install rclone
        run: sudo apt install -y rclone

      - name: âš™ï¸ Configure rclone
        run: |
          # ä½¿ç”¨éžäº¤äº’æ¨¡å¼é…ç½®
          {
            echo "[alist_webdav]"
            echo "type = webdav"
            echo "url = https://${{ secrets.WEBDAV_HOST }}:${{ secrets.WEBDAV_PORT }}/dav"
            echo "vendor = other"
            echo "user = ${{ secrets.ALIST_USERNAME }}"
            echo "pass = ${{ secrets.ALIST_PASSWORD }}"
          } | rclone config create alist_webdav webdav - || true
          
          # å¦‚æžœä¸Šé¢å¤±è´¥ï¼Œæ‰‹åŠ¨åˆ›å»ºé…ç½®æ–‡ä»¶
          if [ ! -f ~/.config/rclone/rclone.conf ]; then
            mkdir -p ~/.config/rclone
            cat > ~/.config/rclone/rclone.conf << EOF
[alist_webdav]
type = webdav
url = https://${{ secrets.WEBDAV_HOST }}:${{ secrets.WEBDAV_PORT }}/dav
vendor = other
user = ${{ secrets.ALIST_USERNAME }}
pass = ${{ secrets.ALIST_PASSWORD }}
EOF
          fi

      - name: ðŸ“¤ Sync to AList
        run: rclone sync ./ alist_webdav:/ --checksum --ignore-times --retries 3 -v

      - name: ðŸ§¹ Clean up
        if: always()
        run: rm -rf ~/.config/rclone
