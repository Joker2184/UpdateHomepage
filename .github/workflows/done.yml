name: Sync to Alist via WebDAV

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  sync_to_alist:
    runs-on: ubuntu-latest
    steps:
      # ç­¾å‡ºä»“åº“
      - name: Checkout repository
        uses: actions/checkout@v3

      # å®‰è£… rclone
      - name: ğŸš€ Install rclone
        run: |
          curl https://rclone.org/install.sh | sudo bash

      # é…ç½® rclone for WebDAV (Alist)
      - name: âš™ï¸ Configure rclone for WebDAV
        run: |
          rclone config create alist_webdav webdav \
            url https://pclhomeplazaoss.lingyunawa.top:26993 \
            vendor other \
            user Joker2184 \
            pass Joker2184@Alist

      # åŒæ­¥ä»“åº“å†…å®¹åˆ°WebDAV (ç›´æ¥åˆ é™¤æ‰€æœ‰æ–‡ä»¶å†å¤åˆ¶)
      - name: ğŸ“¤ Sync all repository files to Alist
        run: |
          echo "Syncing repository to WebDAV..."
          # å…ˆæ¸…ç©ºç›®æ ‡ç›®å½• (ä½¿ç”¨rclone purge)
          rclone purge alist_webdav:/ --retries 3
          
          # ç„¶åå¤åˆ¶æ‰€æœ‰æ–‡ä»¶
          rclone copy ./ alist_webdav:/ --checksum --size-only --retries 3 \
            --exclude ".git/**" --exclude ".github/**" --verbose

      # éªŒè¯åŒæ­¥ç»“æœ
      - name: ğŸ§ª Verify sync result
        run: |
          echo "Sync completed. Verifying contents:"
          rclone ls alist_webdav:/ --recursive | head -20
          echo "Total size:"
          rclone size alist_webdav:/

      # æ¸…ç† rclone é…ç½®
      - name: ğŸ§¹ Clean up rclone config
        if: always()
        run: rm -rf ï½/.config/rclone
