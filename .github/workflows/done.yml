name: Sync to Alist via WebDAV

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  sync_to_alist:
    runs-on: ubuntu-latest
    steps:
      # Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # Install rclone
      - name: Install rclone
        run: |
          curl https://rclone.org/install.sh | sudo bash

      # Configure rclone for WebDAV with test credentials
      - name: Configure rclone for WebDAV
        run: |
          rclone config create alist_webdav webdav \
            url https://pclhomeplazaoss.lingyunawa.top:26993 \
            vendor other \
            user Joker2184 \
            pass Joker2184@Alist

      # Check current working directory (debugging step)
      - name: Print current working directory
        run: |
          pwd
          ls -al

      # Clear the target folder on Alist WebDAV
      - name: Clear target folder on Alist WebDAV
        run: |
          rclone ls alist_webdav:/
          rclone delete alist_webdav:/ --rmdirs  # Deletes all files and empty directories from the target folder

      # Sync all files to Alist WebDAV (sync the entire repo)
      - name: Sync all files to Alist
        run: |
          rclone copy ./ alist_webdav:/ --checksum --size-only --retries 3  # Force update every time

      # List files after sync (verification)
      - name: Verify sync
        run: |
          rclone ls alist_webdav:/ --recursive | head -20
          rclone size alist_webdav:/

      # Optionally, clean up rclone configuration (for security)
      - name: Clean up rclone config
        run: rm -rf ~/.config/rclone
