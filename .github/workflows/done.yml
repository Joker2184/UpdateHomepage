name: Sync to Alist via Hybrid Protocol

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  sync_to_alist:
    runs-on: ubuntu-latest
    steps:
      # ç­¾å‡ºä»“åº“
      - name: Checkout repository
        uses: actions/checkout@v3

      # å®‰è£… rclone
      - name: ğŸš€ Install rclone
        run: |
          curl https://rclone.org/install.sh | sudo bash

      # é…ç½® FTP ç”¨äºæ–‡ä»¶åˆ é™¤ï¼ˆç»•è¿‡ WebDAV 405 é”™è¯¯ï¼‰
      - name: âš™ï¸ Configure FTP for file deletion
        run: |
          rclone config create alist_ftp ftp \
            host pclhomeplazaoss.lingyunawa.top \
            port 21 \
            user Joker2184 \
            pass Joker2184@Alist \
            passive true \
            tls false

      # é…ç½® WebDAV ç”¨äºæ–‡ä»¶ä¼ è¾“
      - name: âš™ï¸ Configure WebDAV for file upload
        run: |
          rclone config create alist_webdav webdav \
            url https://pclhomeplazaoss.lingyunawa.top:26993 \
            vendor other \
            user Joker2184 \
            pass Joker2184@Alist

      # 1. ä½¿ç”¨ FTP åˆ é™¤æ‰€æœ‰æ–‡ä»¶ï¼ˆé¿å… WebDAV 405 é”™è¯¯ï¼‰
      - name: ğŸ—‘ï¸ Delete all files via FTP
        run: |
          echo "Deleting all files using FTP (avoiding WebDAV 405 errors)..."
          rclone delete alist_ftp:/ --retries 3 || true
          echo "FTP deletion completed (ignoring directory removal errors)"

      # 2. ä½¿ç”¨ WebDAV ä¸Šä¼ æ‰€æœ‰æ–‡ä»¶ï¼ˆå®‰å…¨ä¼ è¾“ï¼‰
      - name: ğŸ“¤ Upload files via WebDAV
        run: |
          echo "Uploading all repository files via WebDAV..."
          rclone copy ./ alist_webdav:/ \
            --checksum \
            --size-only \
            --retries 3 \
            --exclude ".git/**" \
            --exclude ".github/**" \
            --verbose

      # 3. éªŒè¯åŒæ­¥ç»“æœ
      - name: âœ… Verify sync
        run: |
          echo "Sync completed. Verifying contents:"
          rclone ls alist_webdav:/ --max-depth 2 | head -15
          rclone size alist_webdav:/

      # æ¸…ç† rclone é…ç½®
      - name: ğŸ§¹ Clean up rclone config
        if: always()
        run: rm -rf ï½/.config/rclone
