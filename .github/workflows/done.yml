name: Sync to Alist via WebDAV

on:
  schedule:
    - cron: "0 1 * * *"  # æ¯å¤© UTC 1 ç‚¹è‡ªåŠ¨è¿è¡Œ
  workflow_dispatch:     # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync_to_alist:
    runs-on: ubuntu-latest
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ğŸ” Checkout repository
        uses: actions/checkout@v4

      # 2. å®‰è£… rcloneï¼ˆæ›´ç¨³å®šçš„æ–¹å¼ï¼‰
      - name: ğŸš€ Install rclone
        run: |
          echo "Installing rclone via apt..."
          sudo apt update
          sudo apt install -y rclone
          rclone version

      # 3. è°ƒè¯•ï¼šæ‰“å°é…ç½®ä¿¡æ¯ï¼ˆsecrets ä¼šè¢« GitHub è‡ªåŠ¨ mask ä¸º ***ï¼‰
      - name: ğŸ” Debug: Show configuration (safe)
        run: |
          echo "WEBDAV_HOST: ${{ secrets.WEBDAV_HOST }}"
          echo "WEBDAV_PORT: ${{ secrets.WEBDAV_PORT }}"
          echo "ALIST_USERNAME: ${{ secrets.ALIST_USERNAME }}"
          echo "WebDAV URL: https://${{ secrets.WEBDAV_HOST }}:${{ secrets.WEBDAV_PORT }}/dav"

      # 4. é…ç½® rclone remote
      - name: âš™ï¸ Configure rclone for AList WebDAV
        run: |
          echo "Creating rclone config 'alist_webdav'..."
          rclone config create alist_webdav webdav \
            url "https://${{ secrets.WEBDAV_HOST }}:${{ secrets.WEBDAV_PORT }}/dav" \
            vendor "other" \
            user "${{ secrets.ALIST_USERNAME }}" \
            pass "${{ secrets.ALIST_PASSWORD }}"
          echo "âœ… rclone config created."

      # 5. æµ‹è¯•è¿æ¥ï¼šåˆ—å‡ºè¿œç¨‹ç›®å½•
      - name: ğŸ“‹ Test: List files on AList WebDAV
        run: |
          echo "Testing connection by listing remote directory..."
          rclone lsd alist_webdav: --verbose

      # 6. åŒæ­¥æœ¬åœ°æ–‡ä»¶åˆ° AList
      - name: ğŸ“¤ Sync files to AList WebDAV
        run: |
          echo "Starting sync from current directory to alist_webdav:/ ..."
          rclone sync ./ alist_webdav:/ \
            --checksum \
            --ignore-times \
            --retries 3 \
            --verbose \
            --progress

      # 7. æ¸…ç†é…ç½®ï¼ˆé˜²æ­¢æ•æ„Ÿä¿¡æ¯æ®‹ç•™ï¼‰
      - name: ğŸ§¹ Clean up rclone config
        if: always()
        run: |
          echo "Cleaning up rclone configuration..."
          rm -rf ï½/.config/rclone
